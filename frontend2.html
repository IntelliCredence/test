<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Figma Test Case Generator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-primary: #0b1021;
            --bg-secondary: #11162c;
            --bg-tertiary: #1b233d;
            --bg-card: linear-gradient(145deg, rgba(30, 41, 59, 0.82), rgba(17, 24, 39, 0.8));
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-tertiary: #94a3b8;
            --accent-primary: #3b82f6;
            --accent-secondary: #8b5cf6;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-error: #ef4444;
            --accent-info: #0ea5e9;
            --border-color: rgba(148, 163, 184, 0.1);
            --shadow-lg: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            --radius-lg: 16px;
            --radius-md: 12px;
            --radius-sm: 8px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at 20% 20%, rgba(99, 102, 241, 0.08), transparent 25%),
                        radial-gradient(circle at 80% 0%, rgba(16, 185, 129, 0.07), transparent 20%),
                        radial-gradient(circle at 50% 80%, rgba(14, 165, 233, 0.06), transparent 25%),
                        linear-gradient(135deg, var(--bg-primary) 0%, #0f1530 50%, #060815 100%);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--bg-card);
            backdrop-filter: blur(14px);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            box-shadow: 0 18px 36px rgba(0,0,0,0.35);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .logo-text h1 {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(to right, #f8fafc, #cbd5e1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo-text p {
            color: var(--text-tertiary);
            font-size: 0.85rem;
        }

        /* View Toggle */
        .view-toggle {
            display: flex;
            gap: 0.5rem;
        }

        .view-toggle button {
            padding: 0.7rem 1.2rem;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
        }

        .view-toggle button.active {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border-color: transparent;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            backdrop-filter: blur(14px);
            border: 1px solid rgba(148, 163, 184, 0.18);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: 0 24px 48px rgba(0,0,0,0.35);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            border-color: rgba(59, 130, 246, 0.4);
            transform: translateY(-4px);
        }

        .card::after {
            content: "";
            position: absolute;
            top: -30%;
            left: -20%;
            width: 60%;
            height: 140%;
            background: linear-gradient(120deg, rgba(255,255,255,0.08), rgba(255,255,255,0));
            transform: rotate(12deg);
            pointer-events: none;
            filter: blur(6px);
        }

        /* Form View (Initial) - ALWAYS VISIBLE FIRST */
        .form-view {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-input {
            width: 100%;
            padding: 0.9rem 1rem;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            transition: var(--transition);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-help {
            font-size: 0.85rem;
            color: var(--text-tertiary);
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.7rem;
            padding: 0.9rem 1.8rem;
            border: none;
            border-radius: var(--radius-md);
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Progress View */
        .progress-view {
            display: none;
        }

        .progress-bar-container {
            margin-bottom: 2rem;
        }

        .progress-bar {
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 4px;
            transition: width 0.5s ease;
            width: 0%;
        }

        .logs-container {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }

        .log-entry {
            padding: 0.8rem;
            border-left: 3px solid transparent;
            margin-bottom: 0.5rem;
            border-radius: var(--radius-sm);
            background: rgba(30, 41, 59, 0.5);
            display: flex;
            gap: 1rem;
        }

        .log-entry.info { border-left-color: var(--accent-primary); }
        .log-entry.success { border-left-color: var(--accent-success); }
        .log-entry.error { border-left-color: var(--accent-error); }

        /* Dashboard View - HIDDEN BY DEFAULT */
        .dashboard-view {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dashboard Tabs */
        .dashboard-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: var(--bg-card);
            padding: 0.5rem;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }

        .tab-btn {
            flex: 1;
            padding: 1rem;
            background: transparent;
            border: none;
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
        }

        .tab-btn:hover:not(.active) {
            background: var(--bg-tertiary);
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Enhanced Dashboard Styles */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            text-align: center;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-primary);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 1rem;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(to right, #f8fafc, #cbd5e1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-tertiary);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Design Analysis Section */
        .design-analysis-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .analysis-card {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 2rem;
            transition: var(--transition);
        }

        .analysis-card:hover {
            transform: translateY(-2px);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .analysis-card.positive {
            border-left: 4px solid var(--accent-success);
        }

        .analysis-card.negative {
            border-left: 4px solid var(--accent-error);
        }

        .analysis-card.improvement {
            border-left: 4px solid var(--accent-warning);
        }

        .analysis-card.correction {
            border-left: 4px solid var(--accent-info);
        }

        .analysis-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .analysis-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .analysis-card.positive .analysis-icon {
            background: rgba(16, 185, 129, 0.1);
            color: var(--accent-success);
        }

        .analysis-card.negative .analysis-icon {
            background: rgba(239, 68, 68, 0.1);
            color: var(--accent-error);
        }

        .analysis-card.improvement .analysis-icon {
            background: rgba(245, 158, 11, 0.1);
            color: var(--accent-warning);
        }

        .analysis-card.correction .analysis-icon {
            background: rgba(14, 165, 233, 0.1);
            color: var(--accent-info);
        }

        .analysis-list {
            list-style: none;
        }

        .analysis-list li {
            padding: 0.8rem 1rem;
            margin-bottom: 0.5rem;
            background: rgba(30, 41, 59, 0.5);
            border-radius: var(--radius-sm);
            border-left: 3px solid transparent;
            transition: var(--transition);
        }

        .analysis-list li:hover {
            background: var(--bg-tertiary);
            transform: translateX(5px);
        }

        .analysis-card.positive .analysis-list li {
            border-left-color: var(--accent-success);
        }

        .analysis-card.negative .analysis-list li {
            border-left-color: var(--accent-error);
        }

        .analysis-card.improvement .analysis-list li {
            border-left-color: var(--accent-warning);
        }

        .analysis-card.correction .analysis-list li {
            border-left-color: var(--accent-info);
        }

        /* Charts Section */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-container {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 2rem;
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.7rem;
        }

        .chart-placeholder {
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-tertiary);
        }

        /* Test Cases Breakdown */
        .breakdown-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .breakdown-card {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 2rem;
        }

        .breakdown-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: rgba(30, 41, 59, 0.5);
            border-radius: var(--radius-sm);
            border-left: 4px solid var(--accent-primary);
        }

        .breakdown-label {
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .breakdown-value {
            font-size: 1.3rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            background: linear-gradient(to right, #f8fafc, #cbd5e1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Section Wise Analysis */
        .sections-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .section-card {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            transition: var(--transition);
        }

        .section-card:hover {
            transform: translateY(-3px);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .section-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .section-name {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .section-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .stat {
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .stat-label-small {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
        }

        /* Quality Metrics */
        .quality-metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            text-align: center;
        }

        .metric-value {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .metric-good { color: var(--accent-success); }
        .metric-average { color: var(--accent-warning); }
        .metric-poor { color: var(--accent-error); }

        .metric-bar {
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .metric-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 1s ease;
        }

        .metric-good .metric-fill { background: var(--accent-success); }
        .metric-average .metric-fill { background: var(--accent-warning); }
        .metric-poor .metric-fill { background: var(--accent-error); }

        /* Recommendations */
        .recommendations-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .recommendation-card {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 2rem;
        }

        .recommendation-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            margin-bottom: 1rem;
            background: rgba(30, 41, 59, 0.5);
            border-radius: var(--radius-sm);
            border-left: 4px solid var(--accent-warning);
        }

        .recommendation-icon {
            color: var(--accent-warning);
            font-size: 1.2rem;
            margin-top: 0.2rem;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--accent-success), #059669);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, var(--accent-info), #0369a1);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--accent-warning), #d97706);
            color: white;
        }

        /* Loading States */
        .loading-spinner {
            text-align: center;
            padding: 3rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: var(--accent-primary);
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 1400px) {
            .dashboard-grid { grid-template-columns: repeat(4, 1fr); }
            .design-analysis-grid { grid-template-columns: 1fr; }
            .charts-grid { grid-template-columns: 1fr; }
            .breakdown-grid { grid-template-columns: 1fr; }
            .sections-grid { grid-template-columns: repeat(2, 1fr); }
            .quality-metrics { grid-template-columns: repeat(2, 1fr); }
            .recommendations-grid { grid-template-columns: 1fr; }
        }

        @media (max-width: 1024px) {
            .dashboard-grid { grid-template-columns: repeat(2, 1fr); }
            .sections-grid { grid-template-columns: 1fr; }
            .quality-metrics { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 768px) {
            .form-view { grid-template-columns: 1fr; }
            .dashboard-grid { grid-template-columns: 1fr; }
            .quality-metrics { grid-template-columns: 1fr; }
            .dashboard-tabs { flex-wrap: wrap; }
            .tab-btn { min-width: 120px; }
            .header { flex-direction: column; gap: 1rem; }
        }

        /* Utility Classes */
        .hidden { display: none !important; }
        .mt-2 { margin-top: 2rem; }
        .mb-2 { margin-bottom: 2rem; }
        .text-center { text-align: center; }
        .text-success { color: var(--accent-success); }
        .text-warning { color: var(--accent-warning); }
        .text-error { color: var(--accent-error); }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(10px);
        }

        .loading-content {
            text-align: center;
            background: var(--bg-card);
            padding: 3rem;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            max-width: 400px;
            width: 90%;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-primary);
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay (Hidden by default) -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <h3 id="loadingMessage">Loading Dashboard Data...</h3>
            <p id="loadingSubtext" class="text-tertiary mt-2">This may take a few moments</p>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-vial"></i>
                </div>
                <div class="logo-text">
                    <h1>Figma Test Case Generator</h1>
                    <p id="headerSubtext">AI-powered test case generation from Figma designs</p>
                </div>
            </div>
            <div class="view-toggle">
                <button id="backToFormBtn" class="hidden">
                    <i class="fas fa-arrow-left"></i>
                    New Generation
                </button>
            </div>
        </header>

        <!-- Form View (ALWAYS VISIBLE FIRST) -->
        <div id="formView" class="form-view">
            <div class="card">
                <h2 style="margin-bottom: 1.5rem; font-size: 1.3rem;">
                    <i class="fas fa-rocket"></i> Generate Test Cases
                </h2>
                <form id="generationForm">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-project-diagram"></i>
                            Project Name
                        </label>
                        <input type="text" id="projectName" class="form-input" 
                               placeholder="Enter project name" value="Figma Design Project" required>
                        <div class="form-help">
                            <i class="fas fa-info-circle"></i>
                            Name for your test suite
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-key"></i>
                            Figma Access Token
                        </label>
                        <input type="password" id="figmaToken" class="form-input" 
                               placeholder="Enter Figma personal access token" required>
                        <div class="form-help">
                            <i class="fas fa-shield-alt"></i>
                            Get it from Figma Account Settings
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-link"></i>
                            Figma File URL or Key
                        </label>
                        <input type="text" id="fileKey" class="form-input" 
                               placeholder="https://www.figma.com/file/..." required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-expand-alt"></i>
                            Image Scale
                        </label>
                        <select id="scale" class="form-input">
                            <option value="2">2x (Standard)</option>
                            <option value="3" selected>3x (High Quality)</option>
                            <option value="4">4x (Ultra Quality)</option>
                        </select>
                    </div>

                    <button type="submit" id="generateBtn" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-bolt"></i>
                        Generate Test Cases
                    </button>
                </form>
            </div>

            <div class="card" id="progressCard">
                <h2 style="margin-bottom: 1.5rem; font-size: 1.3rem;">
                    <i class="fas fa-tasks"></i> Generation Progress
                </h2>
                <div class="progress-bar-container">
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; color: var(--text-tertiary); font-size: 0.9rem;">
                        <span id="progressPercentage">0%</span>
                        <span id="progressStep">Ready to start</span>
                    </div>
                </div>
                <div class="logs-container">
                    <div id="logsContainer">
                        <div class="log-entry info">
                            <span style="font-family: 'JetBrains Mono', monospace; color: var(--text-tertiary); min-width: 70px;">00:00:00</span>
                            <span>Welcome! Enter your Figma details to get started.</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard View (HIDDEN BY DEFAULT - Only shows after generation) -->
        <div id="dashboardView" class="dashboard-view">
            <!-- Dashboard Tabs -->
            <div class="dashboard-tabs">
                <button class="tab-btn active" onclick="switchTab('overview')">
                    <i class="fas fa-tachometer-alt"></i>
                    Overview
                </button>
                <button class="tab-btn" onclick="switchTab('analysis')">
                    <i class="fas fa-search"></i>
                    Design Analysis
                </button>
                <button class="tab-btn" onclick="switchTab('testcases')">
                    <i class="fas fa-vial"></i>
                    Test Cases
                </button>
                <button class="tab-btn" onclick="switchTab('quality')">
                    <i class="fas fa-star"></i>
                    Quality Metrics
                </button>
                <button class="tab-btn" onclick="switchTab('recommendations')">
                    <i class="fas fa-lightbulb"></i>
                    Recommendations
                </button>
            </div>

            <!-- Overview Tab -->
            <div id="overviewTab" class="tab-content active">
                <div class="card" style="margin-bottom:1.5rem;">
                    <h3 class="chart-title">
                        <i class="fas fa-info-circle"></i>
                        Analysis Summary
                    </h3>
                    <p id="analysisDescription" class="text-tertiary" style="margin-bottom:0.75rem;"></p>
                    <div id="testerInsights" class="insights-grid"></div>
                </div>

                <!-- Stats Grid -->
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-vial"></i>
                        </div>
                        <div class="stat-value" id="dashTestCases">0</div>
                        <div class="stat-label">Test Cases</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-layer-group"></i>
                        </div>
                        <div class="stat-value" id="dashFrames">0</div>
                        <div class="stat-label">Frames Analyzed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-sitemap"></i>
                        </div>
                        <div class="stat-value" id="dashSections">0</div>
                        <div class="stat-label">Sections</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-cube"></i>
                        </div>
                        <div class="stat-value" id="dashComponents">0</div>
                        <div class="stat-label">Components</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-value" id="dashTime">0s</div>
                        <div class="stat-label">Processing Time</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-hashtag"></i>
                        </div>
                        <div class="stat-value" id="dashSession">–</div>
                        <div class="stat-label">Session ID</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-sync-alt"></i>
                        </div>
                        <div class="stat-value" id="dashUpdated">–</div>
                        <div class="stat-label">Last Updated</div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="charts-grid mb-2">
                    <div class="chart-container">
                        <h3 class="chart-title">
                            <i class="fas fa-chart-pie"></i>
                            Test Case Distribution
                        </h3>
                        <div class="chart-placeholder">
                            <canvas id="testCaseChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3 class="chart-title">
                            <i class="fas fa-chart-line"></i>
                            Quality Score Trend
                        </h3>
                        <div class="chart-placeholder">
                            <canvas id="qualityChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Sections Breakdown -->
                <h3 class="chart-title mb-2">
                    <i class="fas fa-object-group"></i>
                    Section-wise Analysis
                </h3>
                <div class="sections-grid mb-2" id="sectionsContainer">
                    <!-- Sections will be dynamically added here -->
                </div>

                <!-- Analytics -->
                <div class="breakdown-grid">
                    <div class="breakdown-card">
                        <h3 class="chart-title">
                            <i class="fas fa-robot"></i>
                            AI Analytics
                        </h3>
                        <div class="breakdown-list">
                            <div class="breakdown-item">
                                <div class="breakdown-label">
                                    <i class="fas fa-bolt"></i>
                                    <span>API Calls</span>
                                </div>
                                <div class="breakdown-value" id="dashApiCalls">0</div>
                            </div>
                            <div class="breakdown-item">
                                <div class="breakdown-label">
                                    <i class="fas fa-coins"></i>
                                    <span>Tokens Used</span>
                                </div>
                                <div class="breakdown-value" id="dashTokens">0</div>
                            </div>
                            <div class="breakdown-item">
                                <div class="breakdown-label">
                                    <i class="fas fa-tachometer-alt"></i>
                                    <span>Avg Time/Frame</span>
                                </div>
                                <div class="breakdown-value" id="dashAvgTime">0s</div>
                            </div>
                        </div>
                    </div>

                    <div class="breakdown-card">
                        <h3 class="chart-title">
                            <i class="fas fa-mobile-alt"></i>
                            Platform Distribution
                        </h3>
                        <div class="breakdown-list" id="platformDistribution">
                            <!-- Platforms will be dynamically added here -->
                        </div>
                    </div>
                    <div class="breakdown-card">
                        <h3 class="chart-title">
                            <i class="fas fa-layer-group"></i>
                            Element Inventory
                        </h3>
                        <div class="breakdown-list" id="elementInventory">
                            <!-- Element stats populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Design Analysis Tab -->
            <div id="analysisTab" class="tab-content">
                <div class="design-analysis-grid">
                    <div class="analysis-card positive">
                        <div class="analysis-header">
                            <div class="analysis-icon">
                                <i class="fas fa-thumbs-up"></i>
                            </div>
                            <div>
                                <h3>Design Positives</h3>
                                <p class="text-tertiary">Strengths identified in the design</p>
                            </div>
                        </div>
                        <ul class="analysis-list" id="positivesList">
                            <!-- Positives will be added here -->
                        </ul>
                    </div>

                    <div class="analysis-card negative">
                        <div class="analysis-header">
                            <div class="analysis-icon">
                                <i class="fas fa-thumbs-down"></i>
                            </div>
                            <div>
                                <h3>Design Issues</h3>
                                <p class="text-tertiary">Problems that need attention</p>
                            </div>
                        </div>
                        <ul class="analysis-list" id="negativesList">
                            <!-- Negatives will be added here -->
                        </ul>
                    </div>

                    <div class="analysis-card correction">
                        <div class="analysis-header">
                            <div class="analysis-icon">
                                <i class="fas fa-wrench"></i>
                            </div>
                            <div>
                                <h3>Required Corrections</h3>
                                <p class="text-tertiary">Critical fixes needed</p>
                            </div>
                        </div>
                        <ul class="analysis-list" id="correctionsList">
                            <!-- Corrections will be added here -->
                        </ul>
                    </div>

                    <div class="analysis-card improvement">
                        <div class="analysis-header">
                            <div class="analysis-icon">
                                <i class="fas fa-rocket"></i>
                            </div>
                            <div>
                                <h3>Improvement Suggestions</h3>
                                <p class="text-tertiary">Enhancements for better UX</p>
                            </div>
                        </div>
                        <ul class="analysis-list" id="improvementsList">
                            <!-- Improvements will be added here -->
                        </ul>
                    </div>
                </div>

                <div class="charts-grid mt-2">
                    <div class="chart-container">
                        <h3 class="chart-title">
                            <i class="fas fa-balance-scale"></i>
                            Design Balance Analysis
                        </h3>
                        <div class="chart-placeholder">
                            <canvas id="designBalanceChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3 class="chart-title">
                            <i class="fas fa-exclamation-triangle"></i>
                            Issue Severity Distribution
                        </h3>
                        <div class="chart-placeholder">
                            <canvas id="issueSeverityChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Test Cases Tab -->
            <div id="testcasesTab" class="tab-content">
                <div class="breakdown-grid">
                    <div class="breakdown-card">
                        <h3 class="chart-title">
                            <i class="fas fa-filter"></i>
                            Test Case Breakdown
                        </h3>
                        <div class="breakdown-list" id="testCaseBreakdown">
                            <!-- Test case categories will be added here -->
                        </div>
                    </div>

                    <div class="breakdown-card">
                        <h3 class="chart-title">
                            <i class="fas fa-flag"></i>
                            Priority Distribution
                        </h3>
                        <div class="chart-placeholder">
                            <canvas id="priorityChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="charts-grid mt-2">
                    <div class="chart-container">
                        <h3 class="chart-title">
                            <i class="fas fa-chart-bar"></i>
                            Test Cases by Section
                        </h3>
                        <div class="chart-placeholder">
                            <canvas id="sectionTestChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3 class="chart-title">
                            <i class="fas fa-stream"></i>
                            Test Execution Timeline
                        </h3>
                        <div class="chart-placeholder">
                            <canvas id="timelineChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quality Metrics Tab -->
            <div id="qualityTab" class="tab-content">
                <div class="quality-metrics mb-2">
                    <div class="metric-card metric-good">
                        <h4>Accessibility Score</h4>
                        <div class="metric-value" id="accessibilityScore">0%</div>
                        <div class="metric-bar">
                            <div class="metric-fill" style="width: 0%"></div>
                        </div>
                        <p class="text-tertiary">Color contrast, readability, screen reader support</p>
                    </div>
                    <div class="metric-card metric-average">
                        <h4>Consistency Score</h4>
                        <div class="metric-value" id="consistencyScore">0%</div>
                        <div class="metric-bar">
                            <div class="metric-fill" style="width: 0%"></div>
                        </div>
                        <p class="text-tertiary">Design patterns, spacing, typography consistency</p>
                    </div>
                    <div class="metric-card metric-good">
                        <h4>Usability Score</h4>
                        <div class="metric-value" id="usabilityScore">0%</div>
                        <div class="metric-bar">
                            <div class="metric-fill" style="width: 0%"></div>
                        </div>
                        <p class="text-tertiary">Navigation, form inputs, user flow</p>
                    </div>
                    <div class="metric-card metric-poor">
                        <h4>Error Handling</h4>
                        <div class="metric-value" id="errorHandlingScore">0%</div>
                        <div class="metric-bar">
                            <div class="metric-fill" style="width: 0%"></div>
                        </div>
                        <p class="text-tertiary">Validation, error messages, recovery</p>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-container">
                        <h3 class="chart-title">
                            <i class="fas fa-radar-chart"></i>
                            Quality Radar Chart
                        </h3>
                        <div class="chart-placeholder">
                            <canvas id="radarChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3 class="chart-title">
                            <i class="fas fa-tasks"></i>
                            Test Coverage
                        </h3>
                        <div class="chart-placeholder">
                            <canvas id="coverageChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recommendations Tab -->
            <div id="recommendationsTab" class="tab-content">
                <div class="recommendations-grid">
                    <div class="recommendation-card">
                        <h3 class="chart-title">
                            <i class="fas fa-bug"></i>
                            Critical Issues
                        </h3>
                        <div id="criticalIssues">
                            <!-- Critical issues will be added here -->
                        </div>
                    </div>
                    <div class="recommendation-card">
                        <h3 class="chart-title">
                            <i class="fas fa-magic"></i>
                            UX Improvements
                        </h3>
                        <div id="uxImprovements">
                            <!-- UX improvements will be added here -->
                        </div>
                    </div>
                </div>

                <div class="recommendations-grid mt-2">
                    <div class="recommendation-card">
                        <h3 class="chart-title">
                            <i class="fas fa-shield-alt"></i>
                            Security & Performance
                        </h3>
                        <div id="securityRecommendations">
                            <!-- Security recommendations will be added here -->
                        </div>
                    </div>
                    <div class="recommendation-card">
                        <h3 class="chart-title">
                            <i class="fas fa-mobile-alt"></i>
                            Mobile Optimization
                        </h3>
                        <div id="mobileRecommendations">
                            <!-- Mobile recommendations will be added here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Downloads Section -->
                <div class="card mt-2">
                    <h3 class="chart-title">
                        <i class="fas fa-download"></i>
                        Download Results
                    </h3>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="downloadFile('excel')">
                        <i class="fas fa-file-excel"></i>
                        Download Excel Report
                    </button>
                    <button class="btn btn-success" onclick="downloadFile('archive')">
                        <i class="fas fa-file-archive"></i>
                        Download Test Archive
                    </button>
                    <button class="btn btn-info" onclick="downloadFile('analysis')">
                        <i class="fas fa-chart-bar"></i>
                        Download Analysis Data
                    </button>
                    <button class="btn btn-warning" onclick="generateReport()">
                        <i class="fas fa-file-pdf"></i>
                        Generate PDF Report
                    </button>
                </div>
                <div class="breakdown-list" id="cloudLinks">
                    <!-- Cloud links will be injected -->
                </div>
            </div>
        </div>
    </div>

    <script>
    // State
    let currentView = 'form';
    let pollingInterval;
    let currentResults = null;
    let dashboardData = null;
    let liveUpdateInterval = null;

    // Chart instances
    let testCaseChart, qualityChart, priorityChart, designBalanceChart, sectionChart, timelineChart, radarChart, coverageChart, issueSeverityChart;

    // DOM Elements
    const formView = document.getElementById('formView');
    const dashboardView = document.getElementById('dashboardView');
    const backToFormBtn = document.getElementById('backToFormBtn');
    const generateBtn = document.getElementById('generateBtn');
    const generationForm = document.getElementById('generationForm');
    const progressFill = document.getElementById('progressFill');
    const progressPercentage = document.getElementById('progressPercentage');
    const progressStep = document.getElementById('progressStep');
    const logsContainer = document.getElementById('logsContainer');
    const loadingOverlay = document.getElementById('loadingOverlay');

    // Event Listeners
    generationForm.addEventListener('submit', handleGenerate);
    backToFormBtn.addEventListener('click', () => switchView('form'));

    // Main Functions
    async function handleGenerate(e) {
        e.preventDefault();
        
        const projectName = document.getElementById('projectName').value;
        const figmaToken = document.getElementById('figmaToken').value;
        const fileKey = document.getElementById('fileKey').value;
        const scale = document.getElementById('scale').value;

        if (!figmaToken || !fileKey) {
            alert('Please fill in all required fields');
            return;
        }

        generateBtn.disabled = true;
        generateBtn.innerHTML = '<div class="spinner"></div> Generating...';

        try {
            const response = await fetch('/api/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ projectName, figmaToken, fileKey, scale })
            });

            if (!response.ok) throw new Error('Failed to start generation');

            const data = await response.json();
            if (data.status === 'started') {
                addLog('Generation started successfully', 'success');
                startPolling();
            }
        } catch (error) {
            alert(`Error: ${error.message}`);
            generateBtn.disabled = false;
            generateBtn.innerHTML = '<i class="fas fa-bolt"></i> Generate Test Cases';
        }
    }

    function renderCloudLinks() {
        const container = document.getElementById('cloudLinks');
        if (!container) return;

        const paths = dashboardData.cloudPaths || {};
        const session = dashboardData.session_id || '';

        if (!session || Object.keys(paths).length === 0) {
            container.innerHTML = '<div class="breakdown-item">Cloud artifacts will appear after a successful run.</div>';
            return;
        }

        container.innerHTML = Object.entries(paths).map(([label, path]) => `
            <div class="breakdown-item">
                <div class="breakdown-label">
                    <i class="fas fa-link"></i>
                    <span>${label.replace('_', ' ')}</span>
                </div>
                <div class="breakdown-value" title="${path}">${path}</div>
            </div>
        `).join('');
    }

    function startPolling() {
    let lastLogCount = 0;
    let lastProgress = 0;
    
    pollingInterval = setInterval(async () => {
        try {
            const response = await fetch('/api/status');
            if (!response.ok) return;
            
            const status = await response.json();
            
            // Update progress with smooth animation
            if (status.progress !== lastProgress) {
                progressFill.style.width = `${status.progress}%`;
                progressPercentage.textContent = `${Math.round(status.progress)}%`;
                lastProgress = status.progress;
                
                console.log(`Progress: ${status.progress}% - ${status.step}`);
            }
            
            progressStep.textContent = status.step || 'Processing...';
            
            // Add new log messages
            if (status.logs && status.logs.length > lastLogCount) {
                const newLogs = status.logs.slice(lastLogCount);
                newLogs.forEach(log => {
                    addLog(log.message, log.type || 'info', log.timestamp);
                });
                lastLogCount = status.logs.length;
            }
            
            // Update analytics in real-time
            if (status.analytics) {
                const analyticsEl = document.querySelector('.breakdown-list');
                if (analyticsEl && status.analytics.frames_processed) {
                    console.log(`Analytics: ${status.analytics.frames_processed}/${status.analytics.total_frames} frames`);
                }
            }
            
            // Check if complete
            if (status.complete && status.progress >= 100) {
                clearInterval(pollingInterval);
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-bolt"></i> Generate Test Cases';
                
                console.log("✅ Generation complete!");
                currentResults = status.results;
                
                if (currentResults) {
                    addLog('🎉 Generation complete! Loading dashboard...', 'success');
                    
                    // Wait for files to be written
                    setTimeout(() => {
                        console.log("Switching to dashboard view...");
                        switchView('dashboard');
                        loadRealDashboardData();
                    }, 2000);
                }
            }
            
            // Handle error
            if (status.error) {
                clearInterval(pollingInterval);
                console.error('❌ Generation error:', status.error);
                alert(`Error: ${status.error}`);
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-bolt"></i> Generate Test Cases';
            }
            
        } catch (error) {
            console.error('Polling error:', error);
        }
    }, 1000);
}
function destroyAllCharts() {
    const charts = [
        testCaseChart, priorityChart, sectionChart, qualityChart,
        radarChart, coverageChart, timelineChart, designBalanceChart,
        issueSeverityChart
    ];
    
    charts.forEach(chart => {
        if (chart) {
            try {
                chart.destroy();
            } catch (e) {
                console.log('Chart cleanup:', e.message);
            }
        }
    });
    
    testCaseChart = null;
    priorityChart = null;
    sectionChart = null;
    qualityChart = null;
    radarChart = null;
    coverageChart = null;
    timelineChart = null;
    designBalanceChart = null;
    issueSeverityChart = null;
}
    function switchView(view) {
    if (view === 'dashboard') {
        formView.style.display = 'none';
        dashboardView.style.display = 'block';
        backToFormBtn.classList.remove('hidden');
        document.getElementById('headerSubtext').textContent = 'Test case generation completed successfully';
        startLiveUpdates();
    } else {
        formView.style.display = 'grid';
        dashboardView.style.display = 'none';
        backToFormBtn.classList.add('hidden');
        document.getElementById('headerSubtext').textContent = 'AI-powered test case generation from Figma designs';
        
        // ✅ ADD THIS LINE
        destroyAllCharts();
        
        generateBtn.disabled = false;
        generateBtn.innerHTML = '<i class="fas fa-bolt"></i> Generate Test Cases';
            progressFill.style.width = '0%';
            progressPercentage.textContent = '0%';
            progressStep.textContent = 'Ready to start';
            
            // Stop live updates
            stopLiveUpdates();
            
            // Clear logs except first one
            const logs = logsContainer.querySelectorAll('.log-entry');
            for (let i = 1; i < logs.length; i++) {
                logs[i].remove();
            }
        }
        currentView = view;
    }

    // Load Real Dashboard Data
    async function loadRealDashboardData() {
    try {
        showLoading('Loading precise dashboard data...');
        
        console.log("🔄 Starting dashboard data load...");
        
        // Step 1: Load statistics (fast, always available)
        const statsResponse = await fetch('/api/dashboard/real-stats');
        if (!statsResponse.ok) {
            throw new Error('Failed to load statistics');
        }
        const stats = await statsResponse.json();
        if (stats.error) {
            throw new Error(stats.error);
        }
        
        console.log("✅ Stats loaded:", stats);
        
        // Step 2: Load analysis (may take time)
        let analysis = null;
        try {
            const analysisResponse = await fetch('/api/dashboard/real-analysis');
            if (analysisResponse.ok) {
                analysis = await analysisResponse.json();
                if (analysis.error) {
                    console.warn("⚠️ Analysis endpoint returned an error:", analysis.error);
                    analysis = null;
                }
                console.log("✅ Analysis loaded:", analysis);
            } else {
                console.warn("⚠️ Analysis not ready, will use stats only");
            }
        } catch (analysisError) {
            console.warn('Analysis load error:', analysisError);
        }
        
        // Step 3: Build comprehensive dashboard data
    const resolvedLastUpdated = stats.last_updated || analysis?.last_updated || new Date().toISOString();

    dashboardData = {
    testCases: Number(stats.testCases) || 0,
    frames: Number(stats.frames) || 0,
    sections: Number(stats.sections) || 0,
    components: Number(stats.components) || 0,
    time: stats.time || (stats.analytics?.elapsed_time ? `${Math.round(stats.analytics.elapsed_time)}s` : '0s'),
    session_id: stats.session_id || analysis?.session_id || '',

    analytics: stats.analytics || {
        api_calls: 0,
        tokens_used: 0,
        avg_time_per_frame: '0s'
    },

    designAnalysis: analysis?.designAnalysis || {
        design_positives: [`✅ Successfully analyzed ${stats.frames} frames`],
        design_negatives: ['Analysis in progress.'],
        required_corrections: ['Detailed analysis pending.'],
        improvement_suggestions: ['Review in progress.'],
        recommendations: {
            critical_issues: ['Analysis complete'],
            ux_improvements: ['Recommendations being generated'],
            security_recommendations: ['Security review pending'],
            mobile_optimizations: ['Mobile analysis in progress']
        }
    },

    platformDistribution: analysis?.platformDistribution || {'WEB': stats.frames},

    sectionStatistics: analysis?.sectionStatistics || [],

    qualityMetrics: analysis?.qualityMetrics || {
    accessibility: 75,
    consistency: 70,
    usability: 80,
    error_handling: 65,

    radar: {
        Accessibility: 75,
        Consistency: 70,
        Usability: 80,
        "Error Handling": 0
    },

    coverage: {
        functional: 60,
        ux: 70,
        accessibility: 50,
        security: 40
    }
},

testCaseAnalysis: analysis?.testCaseAnalysis || {
    category_distribution: {},
    priority_distribution: {
        Critical: 2,
        High: 4,
        Medium: 5,
        Low: 2
    },
    section_distribution: {
        "Branding Elements": 7,
        "Design Overview": 6
    }
},


    elementStatistics: analysis?.elementStatistics || analysis?.element_statistics || {},
    cloudPaths: stats.cloudPaths || analysis?.cloudPaths || {},
    last_updated: resolvedLastUpdated,
    tester_insights: analysis?.tester_insights || [],
    analysis_description: analysis?.analysis_description || ''
};

    const isEmpty = (!analysis || Object.keys(analysis).length === 0) && dashboardData.frames === 0 && dashboardData.testCases === 0;
    if (isEmpty) {
        dashboardData.designAnalysis = {
            design_positives: [],
            design_negatives: [],
            required_corrections: [],
            improvement_suggestions: [],
            recommendations: {
                critical_issues: [],
                ux_improvements: [],
                security_recommendations: [],
                mobile_optimizations: []
            }
        };
        dashboardData.qualityMetrics = {
            accessibility: 0,
            consistency: 0,
            usability: 0,
            error_handling: 0,
            coverage: {
                functional: 0,
                ux: 0,
                accessibility: 0,
                security: 0
            }
        };
        dashboardData.testCaseAnalysis = {
            category_distribution: {},
            priority_distribution: {},
            section_distribution: {},
            section_breakdown: [],
            total_test_cases: 0
        };
        dashboardData.elementStatistics = {};
        dashboardData.analysis_description = 'No analysis available yet. Run a generation to populate analytics.';
        dashboardData.tester_insights = [];
    }
        
        console.log("✅ Dashboard data built:", dashboardData);
        
        // Step 4: Update UI with accurate data
        updateDashboardWithRealData();
        initializeCharts();
        updateChartsWithRealData();
        hideLoading();
        
        showNotification('✅ Dashboard loaded with accurate data!', 'success');
        
    } catch (error) {
        console.error('❌ Dashboard load error:', error);
        hideLoading();
        showNotification('Error loading dashboard: ' + error.message, 'error');
    }
}
    // Update Dashboard with Real Data
    function updateDashboardWithRealData() {
    if (!dashboardData) {
        console.error('❌ No dashboard data available');
        return;
    }
    
    console.log("🔄 Updating dashboard UI with data:", dashboardData);
    
    // Update Core Stats with ACTUAL numbers
    const updateElement = (id, value, fallback = '0') => {
        const el = document.getElementById(id);
        if (el) {
            el.textContent = value || fallback;
            console.log(`Updated ${id}: ${value || fallback}`);
        } else {
            console.warn(`Element not found: ${id}`);
        }
    };
    
    updateElement('dashTestCases', formatNumber(dashboardData.testCases));
    updateElement('dashFrames', dashboardData.frames);
    updateElement('dashSections', dashboardData.sections);
    updateElement('dashComponents', formatNumber(dashboardData.components));
    updateElement('dashTime', dashboardData.time);
    
    // Update Analytics
    updateElement('dashApiCalls', dashboardData.analytics.api_calls || '0');
    updateElement('dashTokens', formatNumber(dashboardData.analytics.tokens_used || 0));
    updateElement('dashAvgTime', dashboardData.analytics.avg_time_per_frame || '0s');
    updateElement('dashSession', dashboardData.session_id || '—');
    updateElement('dashUpdated', dashboardData.last_updated || 'Pending');
    
    // Update Design Analysis
    updateRealDesignAnalysis();

    // Analysis summary / insights
    updateAnalysisSummary();

    // Empty-state messaging for analytics
    const emptyMessage = 'No data available yet. Run a generation to see analytics.';
    if ((dashboardData.frames || 0) === 0 && (dashboardData.testCases || 0) === 0) {
        const sectionsContainer = document.getElementById('sectionsContainer');
        if (sectionsContainer) sectionsContainer.innerHTML = `<div class="section-card">${emptyMessage}</div>`;
        const elementInventory = document.getElementById('elementInventory');
        if (elementInventory) elementInventory.innerHTML = `<div class="breakdown-item">${emptyMessage}</div>`;
        const platformDist = document.getElementById('platformDistribution');
        if (platformDist) platformDist.innerHTML = `<div class="breakdown-item">${emptyMessage}</div>`;
    }
    
    // Update Platform Distribution
    updateRealPlatformDistribution();

    // Update Element Inventory
    updateElementInventory();
    
    // Update Sections
    updateRealSections();
    
    // Update Quality Metrics
    updateRealQualityMetrics();
    
    // Update Recommendations
    updateRealRecommendations();
    
    // Update Test Case Breakdown
    updateRealTestCaseBreakdown();

    // Update Cloud Artifacts
    renderCloudLinks();
    
    console.log("✅ Dashboard UI updated successfully");
}

    // Update Real Design Analysis
    function updateRealDesignAnalysis() {
        const analysis = dashboardData.designAnalysis;
        
        // Update positives with REAL data
        const positivesList = document.getElementById('positivesList');
        if (analysis.design_positives && analysis.design_positives.length > 0) {
            positivesList.innerHTML = analysis.design_positives.map(item => 
                `<li>✅ ${item}</li>`
            ).join('');
        } else {
            positivesList.innerHTML = '<li>No positives yet. Run a generation.</li>';
        }
        
        // Update negatives with REAL data
        const negativesList = document.getElementById('negativesList');
        if (analysis.design_negatives && analysis.design_negatives.length > 0) {
            negativesList.innerHTML = analysis.design_negatives.map(item => 
                `<li>⚠️ ${item}</li>`
            ).join('');
        } else {
            negativesList.innerHTML = '<li>No issues yet. Run a generation.</li>';
        }
        
        // Update corrections with REAL data
        const correctionsList = document.getElementById('correctionsList');
        if (analysis.required_corrections && analysis.required_corrections.length > 0) {
            correctionsList.innerHTML = analysis.required_corrections.map(item => 
                `<li>🔧 ${item}</li>`
            ).join('');
        } else {
            correctionsList.innerHTML = '<li>No critical corrections required</li>';
        }
        
        // Update improvements with REAL data
        const improvementsList = document.getElementById('improvementsList');
        if (analysis.improvement_suggestions && analysis.improvement_suggestions.length > 0) {
            improvementsList.innerHTML = analysis.improvement_suggestions.map(item => 
                `<li>🚀 ${item}</li>`
            ).join('');
        } else {
            improvementsList.innerHTML = '<li>No improvement suggestions</li>';
        }
    }

    // Update Real Platform Distribution
    function updateRealPlatformDistribution() {
        const platforms = dashboardData.platformDistribution;
        const container = document.getElementById('platformDistribution');
        
        if (platforms && Object.keys(platforms).length > 0) {
            container.innerHTML = Object.entries(platforms).map(([platform, count]) => `
                <div class="breakdown-item">
                    <div class="breakdown-label">
                        <i class="fas ${getPlatformIcon(platform)}"></i>
                        <span>${platform}</span>
                    </div>
                    <div class="breakdown-value">${count}</div>
                </div>
            `).join('');
        } else {
            container.innerHTML = '<div class="breakdown-item">Platform analysis in progress...</div>';
        }
    }

    function updateElementInventory() {
        const inventory = dashboardData.element_statistics || dashboardData.elementStatistics || {};
        const container = document.getElementById('elementInventory');

        if (!container) return;

        if (inventory && Object.keys(inventory).length > 0) {
            container.innerHTML = Object.entries(inventory).map(([key, value]) => `
                <div class="breakdown-item">
                    <div class="breakdown-label">
                        <i class="fas fa-cube"></i>
                        <span>${key.replace(/_/g, ' ')}</span>
                    </div>
                    <div class="breakdown-value">${formatNumber(value)}</div>
                </div>
            `).join('');
        } else {
            container.innerHTML = '<div class="breakdown-item">Element statistics pending...</div>';
        }
    }

    // Update Real Sections
    function updateRealSections() {
        const sections = dashboardData.sectionStatistics;
        const container = document.getElementById('sectionsContainer');
        
        if (sections && sections.length > 0) {
            container.innerHTML = sections.slice(0, 6).map(section => `
                <div class="section-card">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="fas fa-layer-group"></i>
                        </div>
                        <div class="section-name">${section.name || 'Unnamed Section'}</div>
                    </div>
                    <div class="section-stats">
                        <div class="stat">
                            <div class="stat-number">${section.frames || 0}</div>
                            <div class="stat-label-small">Frames</div>
                        </div>
                        <div class="stat">
                            <div class="stat-number">${section.test_cases || 0}</div>
                            <div class="stat-label-small">Tests</div>
                        </div>
                        <div class="stat">
                            <div class="stat-number">${section.quality_score || 0}%</div>
                            <div class="stat-label-small">Quality</div>
                        </div>
                    </div>
                </div>
            `).join('');
        } else {
            container.innerHTML = '<div class="section-card">Section analysis in progress...</div>';
        }
    }

    // Update Real Quality Metrics
    function updateRealQualityMetrics() {
        const metrics = dashboardData.qualityMetrics || {};
        
        // Update scores with REAL data
        const metricConfigs = [
            { key: 'accessibility', label: 'Accessibility Score', elementId: 'accessibilityScore' },
            { key: 'consistency', label: 'Consistency Score', elementId: 'consistencyScore' },
            { key: 'usability', label: 'Usability Score', elementId: 'usabilityScore' },
            { key: 'error_handling', label: 'Error Handling', elementId: 'errorHandlingScore' }
        ];
        
        metricConfigs.forEach(config => {
            const score = Number(metrics[config.key]) || 0;
            const element = document.getElementById(config.elementId);
            const bar = document.querySelector(`#${config.elementId} + .metric-bar .metric-fill`);
            
            if (element && bar) {
                element.textContent = Math.round(score) + '%';
                element.previousElementSibling.textContent = config.label;
                bar.style.width = score + '%';
                
                // Update color class based on REAL score
                const card = element.closest('.metric-card');
                if (!card) return;
                card.classList.remove('metric-good', 'metric-average', 'metric-poor');
                
                if (score >= 80) card.classList.add('metric-good');
                else if (score >= 60) card.classList.add('metric-average');
                else card.classList.add('metric-poor');
            }
        });
    }

    // Update Real Recommendations
    function updateRealRecommendations() {
    const recs =
        dashboardData?.designAnalysis?.recommendations || {
            critical_issues: [],
            ux_improvements: [],
            security_recommendations: [],
            mobile_optimizations: []
        };

    const updateList = (id, items, icon) => {
        const el = document.getElementById(id);
        if (!el) return;

        if (!items || items.length === 0) {
            el.innerHTML = `<div class="recommendation-item">No items available</div>`;
            return;
        }

        el.innerHTML = items.map(i => `
            <div class="recommendation-item">
                <span class="recommendation-icon">${icon}</span>
                <span>${i}</span>
            </div>
        `).join('');
    };

    // ✅ MATCHING REAL HTML IDS
    updateList('criticalIssues', recs.critical_issues, '🚨');
    updateList('uxImprovements', recs.ux_improvements, '✨');
    updateList('securityRecommendations', recs.security_recommendations, '🔐');
    updateList('mobileRecommendations', recs.mobile_optimizations, '📱');
}

    function updateAnalysisSummary() {
        const descEl = document.getElementById('analysisDescription');
        const insightsEl = document.getElementById('testerInsights');

        if (descEl) {
            descEl.textContent = dashboardData.analysis_description || 'Latest analysis details will appear here after a run.';
        }

        if (insightsEl) {
            const insights = dashboardData.tester_insights || [];
            if (insights.length === 0) {
                insightsEl.innerHTML = '<div class="insight-card">Insights will appear once analysis is available.</div>';
                return;
            }

            insightsEl.innerHTML = insights.map(insight => `
                <div class="insight-card">
                    <div class="insight-title">${insight.title}</div>
                    <p class="insight-description">${insight.description}</p>
                    <ul>
                        ${(insight.bullets || []).map(b => `<li>${b}</li>`).join('')}
                    </ul>
                </div>
            `).join('');
        }
    }



    // Update Real Test Case Breakdown
    function updateRealTestCaseBreakdown() {
        const analysis = dashboardData.testCaseAnalysis;
        const container = document.getElementById('testCaseBreakdown');
        
        if (analysis.category_distribution && Object.keys(analysis.category_distribution).length > 0) {
            const entries = Object.entries(analysis.category_distribution).slice(0, 6);
            container.innerHTML = entries.map(([category, count]) => `
                <div class="breakdown-item">
                    <div class="breakdown-label">
                        <i class="fas fa-file-alt"></i>
                        <span>${category}</span>
                    </div>
                    <div class="breakdown-value">${count}</div>
                </div>
            `).join('');
        } else {
            container.innerHTML = '<div class="breakdown-item">Test case analysis in progress...</div>';
        }
    }

    // Initialize Charts
    function initializeCharts() {
    console.log('🎨 Initializing charts...');
    
    // ✅ STEP 1: Destroy ALL existing chart instances
    if (testCaseChart) { testCaseChart.destroy(); testCaseChart = null; }
    if (priorityChart) { priorityChart.destroy(); priorityChart = null; }
    if (sectionChart) { sectionChart.destroy(); sectionChart = null; }
    if (qualityChart) { qualityChart.destroy(); qualityChart = null; }
    if (radarChart) { radarChart.destroy(); radarChart = null; }
    if (coverageChart) { coverageChart.destroy(); coverageChart = null; }
    if (timelineChart) { timelineChart.destroy(); timelineChart = null; }
    if (designBalanceChart) { designBalanceChart.destroy(); designBalanceChart = null; }
    if (issueSeverityChart) { issueSeverityChart.destroy(); issueSeverityChart = null; }
    
    // ✅ STEP 2: Clear any orphaned Chart.js instances on these canvases
    const canvasIds = [
        'testCaseChart', 'priorityChart', 'sectionTestChart', 'qualityChart',
        'radarChart', 'coverageChart', 'timelineChart', 'designBalanceChart',
        'issueSeverityChart'
    ];
    
    canvasIds.forEach(id => {
        const canvas = document.getElementById(id);
        if (canvas) {
            // Get the chart instance if it exists
            const existingChart = Chart.getChart(canvas);
            if (existingChart) {
                console.log(`Destroying orphaned chart on ${id}`);
                existingChart.destroy();
            }
        }
    });
    
    console.log('✅ All existing charts destroyed');
    
    // ✅ STEP 3: Now create new charts
    // Test Case Distribution Chart
    const testCaseCtx = document.getElementById('testCaseChart')?.getContext('2d');
    if (testCaseCtx) {
        testCaseChart = new Chart(testCaseCtx, {
            type: 'doughnut',
            data: {
                labels: ['Loading real data...'],
                datasets: [{
                    data: [100],
                    backgroundColor: generateColors(6)
                }]
            },
            options: {
                responsive: true,
                cutout: '55%',
                plugins: {
                    legend: { position: 'bottom' },
                    title: {
                        display: true,
                        text: 'Real Test Case Distribution'
                    }
                }
            }
        });
    }

    // Priority Chart
    const priorityCtx = document.getElementById('priorityChart')?.getContext('2d');
    if (priorityCtx) {
        priorityChart = new Chart(priorityCtx, {
            type: 'bar',
            data: {
                labels: ['Loading...'],
                datasets: [{
                    label: 'Priority',
                    data: [0],
                    backgroundColor: generateColors(5)
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }

    // Section Test Cases
    const sectionCtx = document.getElementById('sectionTestChart')?.getContext('2d');
    if (sectionCtx) {
        sectionChart = new Chart(sectionCtx, {
            type: 'bar',
            data: { labels: ['Loading...'], datasets: [{ label: 'Tests', data: [0], backgroundColor: '#8b5cf6' }] },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    // Quality Score Chart
    const qualityCtx = document.getElementById('qualityChart')?.getContext('2d');
    if (qualityCtx) {
        qualityChart = new Chart(qualityCtx, {
            type: 'line',
            data: {
                labels: ['Loading...'],
                datasets: [{
                    label: 'Quality Score',
                    data: [0],
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.15)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { min: 0, max: 100 }
                }
            }
        });
    }

    // Radar Chart
    const radarCtx = document.getElementById('radarChart')?.getContext('2d');
    if (radarCtx) {
        radarChart = new Chart(radarCtx, {
            type: 'radar',
            data: {
                labels: ['Accessibility', 'Consistency', 'Usability', 'Error Handling'],
                datasets: [{
                    label: 'Quality Metrics',
                    data: [0, 0, 0, 0],
                    backgroundColor: 'rgba(59, 130, 246, 0.15)',
                    borderColor: '#3b82f6'
                }]
            },
            options: { responsive: true, scales: { r: { beginAtZero: true, max: 100 } } }
        });
    }

    // Coverage Chart
    const coverageCtx = document.getElementById('coverageChart')?.getContext('2d');
    if (coverageCtx) {
        coverageChart = new Chart(coverageCtx, {
            type: 'bar',
            data: {
                labels: ['Functional', 'UX', 'Accessibility', 'Security'],
                datasets: [{
                    label: 'Coverage %',
                    data: [0, 0, 0, 0],
                    backgroundColor: generateColors(4)
                }]
            },
            options: {
                responsive: true,
                scales: { y: { beginAtZero: true, max: 100 } },
                plugins: { legend: { display: false } }
            }
        });
    }

    // Timeline Chart
    const timelineCtx = document.getElementById('timelineChart')?.getContext('2d');
    if (timelineCtx) {
        timelineChart = new Chart(timelineCtx, {
            type: 'line',
            data: { labels: ['Waiting for data'], datasets: [{ label: 'Tests', data: [0], borderColor: '#f59e0b', tension: 0.35 }] },
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });
    }

    // Design balance
    const balanceCtx = document.getElementById('designBalanceChart')?.getContext('2d');
    if (balanceCtx) {
        designBalanceChart = new Chart(balanceCtx, {
            type: 'bar',
            data: {
                labels: ['Positives', 'Negatives', 'Corrections', 'Improvements'],
                datasets: [{ label: 'Count', data: [0, 0, 0, 0], backgroundColor: generateColors(4) }]
            },
            options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });
    }

    // Issue Severity chart
    const severityCtx = document.getElementById('issueSeverityChart')?.getContext('2d');
    if (severityCtx) {
        issueSeverityChart = new Chart(severityCtx, {
            type: 'doughnut',
            data: {
                labels: ['Critical', 'High', 'Medium', 'Low'],
                datasets: [{
                    label: 'Issue Severity',
                    data: [0, 0, 0, 0],
                    backgroundColor: generateColors(4)
                }]
            },
            options: {
                responsive: true,
                cutout: '60%',
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }
    
    console.log('✅ All charts initialized successfully');
}

    // Update Charts with Real Data
    function updateChartsWithRealData() {
        const analysis = dashboardData.testCaseAnalysis || {};
        
        const hasData = dashboardData.testCases > 0 || dashboardData.frames > 0;

        // Update Test Case Distribution with REAL data
        if (testCaseChart) {
            if (analysis.category_distribution && hasData) {
                const categories = Object.keys(analysis.category_distribution);
                const counts = Object.values(analysis.category_distribution);
                
                testCaseChart.data.labels = categories.slice(0, 12);
                testCaseChart.data.datasets[0].data = counts.slice(0, 12);
                testCaseChart.data.datasets[0].backgroundColor = generateColors(Math.min(12, categories.length));
            } else {
                testCaseChart.data.labels = ['No data'];
                testCaseChart.data.datasets[0].data = [0];
            }
            testCaseChart.update();
        }

        // Priority distribution
        if (priorityChart) {
            if (analysis.priority_distribution && hasData) {
                const labels = Object.keys(analysis.priority_distribution);
                const values = Object.values(analysis.priority_distribution);
                priorityChart.data.labels = labels;
                priorityChart.data.datasets[0].data = values;
                priorityChart.data.datasets[0].backgroundColor = generateColors(labels.length || 4);
            } else {
                priorityChart.data.labels = ['No data'];
                priorityChart.data.datasets[0].data = [0];
            }
            priorityChart.update();
        }

        // Section test cases
        if (sectionChart) {
            if (analysis.section_distribution && hasData) {
                const labels = Object.keys(analysis.section_distribution);
                const values = Object.values(analysis.section_distribution);
                sectionChart.data.labels = labels;
                sectionChart.data.datasets[0].data = values;
            } else {
                sectionChart.data.labels = ['No data'];
                sectionChart.data.datasets[0].data = [0];
            }
            sectionChart.update();
        }
        
        // Update Quality Chart with REAL data
        if (qualityChart) {
            if (dashboardData.sectionStatistics.length > 0) {
                const sections = dashboardData.sectionStatistics.slice(0, 8).map(s =>
                    s.name?.substring(0, 12) + (s.name?.length > 12 ? '...' : '') || 'Section'
                );
                const scores = dashboardData.sectionStatistics.slice(0, 8).map(s => s.quality_score || 0);

                qualityChart.data.labels = sections;
                qualityChart.data.datasets[0].data = scores;
            } else {
                const qm = dashboardData.qualityMetrics;
                qualityChart.data.labels = ['Overall Quality'];
                qualityChart.data.datasets[0].data = [
                    Math.round(
                        (qm.accessibility +
                         qm.consistency +
                         qm.usability +
                         qm.error_handling) / 4
                    )
                ];
            }
            qualityChart.update();
        }

        // Radar chart
        if (radarChart) {
            const qm = dashboardData.qualityMetrics || {};
            if (hasData) {
                radarChart.data.datasets[0].data = [
                    qm.accessibility || 0,
                    qm.consistency || 0,
                    qm.usability || 0,
                    qm.error_handling || 0
                ];
            } else {
                radarChart.data.datasets[0].data = [0, 0, 0, 0];
            }
            radarChart.update();
        }

        // Coverage chart
        if (coverageChart) {
            const coverage = dashboardData.qualityMetrics?.coverage || {};
            if (hasData) {
                coverageChart.data.datasets[0].data = [
                    coverage.functional || 0,
                    coverage.ux || 0,
                    coverage.accessibility || 0,
                    coverage.security || 0
                ];
            } else {
                coverageChart.data.datasets[0].data = [0, 0, 0, 0];
            }
            coverageChart.update();
        }

        // Timeline chart: derive from section distribution cumulatively
        if (timelineChart) {
            if (analysis.section_distribution && hasData) {
                const labels = Object.keys(analysis.section_distribution);
                const values = Object.values(analysis.section_distribution);
                const cumulative = values.reduce((acc, val, idx) => {
                    const prev = idx === 0 ? 0 : acc[idx - 1];
                    acc.push(prev + val);
                    return acc;
                }, []);
                timelineChart.data.labels = labels;
                timelineChart.data.datasets[0].data = cumulative;
            } else {
                timelineChart.data.labels = ['No data'];
                timelineChart.data.datasets[0].data = [0];
            }
            timelineChart.update();
        }

        // Design balance
        if (designBalanceChart) {
            const pos = hasData ? (dashboardData.designAnalysis?.design_positives?.length || 0) : 0;
            const neg = hasData ? (dashboardData.designAnalysis?.design_negatives?.length || 0) : 0;
            const corr = hasData ? (dashboardData.designAnalysis?.required_corrections?.length || 0) : 0;
            const imp = hasData ? (dashboardData.designAnalysis?.improvement_suggestions?.length || 0) : 0;
            designBalanceChart.data.datasets[0].data = [pos, neg, corr, imp];
            designBalanceChart.update();
        }

        // Issue severity (priority mapping)
        if (issueSeverityChart) {
            const priorities = ['Critical', 'High', 'Medium', 'Low'];
            const priorityData = analysis.priority_distribution || {};

            // Normalize priority keys to avoid casing / alias issues
            const normalized = { Critical: 0, High: 0, Medium: 0, Low: 0 };
            Object.entries(priorityData).forEach(([key, value]) => {
                const lower = key.toString().toLowerCase();
                const amount = Number(value) || 0;
                if (lower.includes('crit')) normalized.Critical += amount;
                else if (lower.includes('high')) normalized.High += amount;
                else if (lower.includes('med')) normalized.Medium += amount;
                else if (lower.includes('low')) normalized.Low += amount;
            });

            const values = priorities.map(p => normalized[p]);
            const hasSeverityData = hasData && values.some(v => v > 0);

            issueSeverityChart.data.labels = priorities;
            issueSeverityChart.data.datasets[0].data = hasSeverityData ? values : [0, 0, 0, 0];
            issueSeverityChart.data.datasets[0].backgroundColor = generateColors(priorities.length);
            issueSeverityChart.update();
        }
    }

    // Utility Functions
    function getPlatformIcon(platform) {
        const icons = {
            'WEB': 'fa-desktop',
            'iOS': 'fa-apple',
            'ANDROID': 'fa-android',
            'TABLET': 'fa-tablet-alt',
            'DESKTOP': 'fa-desktop',
            'MOBILE': 'fa-mobile-alt'
        };
        return icons[platform.toUpperCase()] || 'fa-question-circle';
    }

    function formatNumber(num) {
        if (typeof num !== 'number') return num;
        if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
        if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
        return num.toString();
    }

    function generateColors(count) {
        const colors = [
            '#3b82f6', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444', '#0ea5e9',
            '#84cc16', '#f97316', '#ec4899', '#14b8a6', '#64748b', '#8b5cf6'
        ];
        return colors.slice(0, count);
    }

    // Loading State
    function showLoading(message = 'Loading real data...') {
        if (loadingOverlay) {
            const messageEl = document.getElementById('loadingMessage');
            if (messageEl) messageEl.textContent = message;
            loadingOverlay.classList.remove('hidden');
        }
    }

    function hideLoading() {
        if (loadingOverlay) {
            loadingOverlay.classList.add('hidden');
        }
    }

    // Live Updates
    function startLiveUpdates() {
        if (liveUpdateInterval) clearInterval(liveUpdateInterval);
        
        liveUpdateInterval = setInterval(async () => {
            try {
                const response = await fetch('/api/dashboard/live-updates');
                if (response.ok) {
                    const updates = await response.json();
                    if (updates.new_test_cases > 0 || updates.new_frames > 0) {
                        console.log('Live update received:', updates);
                        // Refresh data if there are updates
                        await refreshDashboardData();
                    }
                }
            } catch (error) {
                console.log('Live update error:', error);
            }
        }, 10000); // Check every 10 seconds
    }

    function stopLiveUpdates() {
        if (liveUpdateInterval) {
            clearInterval(liveUpdateInterval);
            liveUpdateInterval = null;
        }
    }
    async function verifyDashboardData() {
    console.log("\n" + "=".repeat(60));
    console.log("🔍 DASHBOARD DATA VERIFICATION");
    console.log("=".repeat(60));
    
    console.log("\n📊 Current Dashboard Data:");
    console.log("Test Cases:", dashboardData?.testCases);
    console.log("Frames:", dashboardData?.frames);
    console.log("Sections:", dashboardData?.sections);
    console.log("Components:", dashboardData?.components);
    console.log("Time:", dashboardData?.time);
    console.log("Session ID:", dashboardData?.session_id);
    
    console.log("\n📈 Analytics:");
    console.log(dashboardData?.analytics);
    
    console.log("\n🎨 Platform Distribution:");
    console.log(dashboardData?.platformDistribution);
    
    console.log("\n📝 Test Case Analysis:");
    console.log(dashboardData?.testCaseAnalysis);
    
    console.log("\n" + "=".repeat(60) + "\n");
}

// Call verification after loading
window.verifyDashboard = verifyDashboardData;

// Add this to your window load event
window.addEventListener('load', () => {
    console.log("🚀 Dashboard initialized");
    console.log("Use window.verifyDashboard() to check data accuracy");
});
    async function refreshDashboardData() {
        try {
            const response = await fetch('/api/dashboard/refresh', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            
            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    dashboardData = {
                        ...dashboardData,
                        ...result.stats,
                        ...result.analysis,
                        designAnalysis: result.analysis?.designAnalysis || dashboardData.designAnalysis
                    };
                    updateDashboardWithRealData();
                    updateChartsWithRealData();
                    showNotification('Dashboard data refreshed!', 'success');
                }
            }
        } catch (error) {
            console.log('Refresh error:', error);
        }
    }

    // Logging
    function addLog(message, type = 'info', timestamp = null) {
        const now = new Date();
        const timeStr = timestamp || 
            `${now.getHours().toString().padStart(2, '0')}:` +
            `${now.getMinutes().toString().padStart(2, '0')}:` +
            `${now.getSeconds().toString().padStart(2, '0')}`;
        
        const logEntry = document.createElement('div');
        logEntry.className = `log-entry ${type}`;
        logEntry.innerHTML = `
            <span style="font-family: 'JetBrains Mono', monospace; color: var(--text-tertiary); min-width: 70px;">${timeStr}</span>
            <span>${message}</span>
        `;
        
        logsContainer.appendChild(logEntry);
        logsContainer.scrollTop = logsContainer.scrollHeight;
    }

    // Real Design Analysis Generator
    async function generateRealDesignAnalysis(stats) {
        // This would be called if real analysis isn't available yet
        return {
            design_positives: [
                `Successfully analyzed ${stats.frames || 0} design frames`,
                `Generated ${stats.testCases || 0} comprehensive test cases`,
                `Identified ${stats.components || 0} UI components`,
                "AI-powered analysis complete"
            ],
            design_negatives: [
                "Detailed analysis still processing...",
                "Some insights may be preliminary"
            ],
            required_corrections: [
                "Waiting for complete analysis results",
                "Check back in a moment for specific corrections"
            ],
            improvement_suggestions: [
                "Real-time analysis in progress",
                "AI insights being generated"
            ],
            recommendations: {
    critical_issues: ['No critical issues found'],
    ux_improvements: ['Improve visual hierarchy'],
    security_recommendations: ['No security risks detected'],
    mobile_optimizations: ['Ensure touch target spacing']
},

balance_metrics: {
    positive: 3,
    negative: 1,
    corrections: 0
},

severity_distribution: {
    critical: 0,
    high: 1,
    medium: 0,
    low: 0
}

        };
    }

    // Enhanced Sample Data (fallback with real stats)
    async function loadEnhancedSampleData() {
        // Use whatever real stats we have
        const statsResponse = await fetch('/api/dashboard/real-stats');
        const stats = statsResponse.ok ? await statsResponse.json() : {};
        
        dashboardData = {
            testCases: stats.testCases || 0,
            frames: stats.frames || 0,
            sections: stats.sections || 0,
            components: stats.components || 0,
            time: stats.time || '0s',
            analytics: stats.analytics || {},
            designAnalysis: await generateRealDesignAnalysis(stats),
            platformDistribution: { 'WEB': 100 },
            sectionStatistics: [],
            qualityMetrics: {
                accessibility: 75,
                consistency: 70,
                usability: 80,
                error_handling: 65
            },
            recommendations: {
                critical_issues: ["Real analysis in progress"],
                ux_improvements: ["Check back for detailed suggestions"],
                security_recommendations: ["Security analysis pending"],
                mobile_optimizations: ["Mobile analysis in progress"]
            },
            testCaseAnalysis: {
                category_distribution: { 'Analysis': 1 }
            }
        };
        
        updateDashboardWithRealData();
        updateChartsWithRealData();
    }

    // Tab Switching
    function switchTab(tabName) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Remove active class from all buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Show selected tab
        const tabElement = document.getElementById(tabName + 'Tab');
        if (tabElement) {
            tabElement.classList.add('active');
        }
        
        // Activate selected button
        if (event && event.target) {
            event.target.classList.add('active');
        }
    }

    // Download Functions
    async function downloadFile(type) {
    try {
        showLoading('Preparing download...');
        
        let url, filename;
        
        switch(type) {
            case 'excel':
                // Use session ID if available
                const sessionId = dashboardData?.session_id || '';
                url = `/api/download/excel-consolidated${sessionId ? '?session_id=' + sessionId : ''}`;
                filename = `test_cases_${sessionId || 'report'}.xlsx`;
                console.log(`📥 Downloading Excel from: ${url}`);
                break;
            case 'archive':
                url = '/api/download/testcases-archive';
                filename = 'test_cases_archive.zip';
                break;
            case 'analysis':
                url = '/api/download/analysis-archive';
                filename = 'design_analysis.zip';
                break;
            default:
                throw new Error('Unknown download type');
        }
        
        console.log(`Fetching: ${url}`);
        const response = await fetch(url);
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Download failed');
        }
        
        const blob = await response.blob();
        console.log(`✅ Downloaded ${blob.size} bytes`);
        
        const downloadUrl = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(downloadUrl);
        a.remove();
        
        hideLoading();
        showNotification(`✅ Downloaded: ${filename}`, 'success');
        
    } catch (error) {
        console.error('❌ Download error:', error);
        hideLoading();
        showNotification('Download failed: ' + error.message, 'error');
    }
}

    function generateReport() {
        showNotification('Real PDF report generation coming soon!', 'info');
    }

    function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `notification-${type}`;
        notification.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
            <span>${message}</span>
        `;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            z-index: 9999;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    // Initialize - Start with form view
    addLog('Application initialized. Enter Figma details to begin.', 'info');
    
    // Check for existing generation on page load (but don't auto-switch)
    setTimeout(async () => {
        try {
            const response = await fetch('/api/status');
            if (response.ok) {
                const status = await response.json();
                if (status.complete && status.results) {
                    // Update the progress bar to show completion
                    progressFill.style.width = '100%';
                    progressPercentage.textContent = '100%';
                    progressStep.textContent = 'Complete';
                    
                    addLog('Previous generation found. Click "New Generation" to start over.', 'info');
                }
            }
        } catch (error) {
            console.log('No existing generation found');
        }
    }, 1000);

    // Add CSS for animations
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        .real-data-badge {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
    `;
    document.head.appendChild(style);

    // Add real data indicators
    function addRealDataIndicators() {
        // Add badge to dashboard title
        const dashboardTitle = document.querySelector('.dashboard-tabs');
        if (dashboardTitle) {
            const badge = document.createElement('span');
            badge.className = 'real-data-badge';
            badge.textContent = 'REAL DATA';
            dashboardTitle.parentElement.insertBefore(badge, dashboardTitle.nextSibling);
        }
    }
</script>
</body>
</html>
