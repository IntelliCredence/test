<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Case Generator</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --card: #1f2937;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #10b981;
      --accent-2: #6366f1;
      --danger: #ef4444;
      --border: rgba(255,255,255,0.08);
      --radius: 12px;
      --shadow: 0 20px 60px rgba(0,0,0,0.45);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(99,102,241,0.12), transparent 25%),
                  radial-gradient(circle at 80% 0%, rgba(16,185,129,0.12), transparent 20%),
                  linear-gradient(180deg, #0b1223, #0f172a);
      color: var(--text);
      min-height: 100vh;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px 20px 64px;
    }
    .header {
      background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(16,185,129,0.1));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 22px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow);
    }
    .title {
      font-size: 24px;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .title span {
      background: linear-gradient(135deg, #10b981, #6366f1);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 700;
    }
    .muted { color: var(--muted); }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
      margin-top: 20px;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: var(--shadow);
    }
    .card h3 { margin: 0 0 12px 0; font-size: 18px; }
    label {
      display: block;
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    input, select, textarea {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #0b1220;
      color: var(--text);
      font-size: 14px;
      transition: border-color 0.2s ease;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(16,185,129,0.12);
    }
    textarea { resize: vertical; min-height: 96px; }
    .btn {
      border: none;
      border-radius: 10px;
      padding: 12px 16px;
      background: linear-gradient(135deg, #10b981, #16a34a);
      color: white;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(16,185,129,0.25);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; }
    .btn.secondary { background: #1f2937; border: 1px solid var(--border); box-shadow: none; }
    .btn:hover:not(:disabled) { transform: translateY(-1px); }
    .status {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      background: #0b1220;
      margin-top: 12px;
    }
    .progress {
      width: 100%;
      height: 8px;
      background: rgba(255,255,255,0.08);
      border-radius: 6px;
      overflow: hidden;
      margin-top: 8px;
    }
    .progress-inner {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #22c55e, #3b82f6);
      transition: width 0.3s ease;
    }
    .messages {
      max-height: 150px;
      overflow: auto;
      font-size: 13px;
      margin-top: 10px;
      padding: 4px;
    }
    .msg { padding: 6px 8px; border-radius: 8px; margin-bottom: 6px; background: rgba(255,255,255,0.04); }
    .msg.success { border: 1px solid rgba(16,185,129,0.5); }
    .msg.error { border: 1px solid rgba(239,68,68,0.5); color: #fecdd3; }
    .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; margin-top: 14px; }
    .summary-card { padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: #111827; }
    .summary-card .label { color: var(--muted); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
    .summary-card .value { font-size: 20px; margin-top: 4px; font-weight: 700; }
    .screen-card { margin-top: 16px; padding: 14px; border: 1px solid var(--border); border-radius: 12px; background: #111827; }
    .case-list { list-style: none; padding-left: 0; margin: 10px 0 0; display: grid; gap: 10px; }
    .case-item { padding: 10px 12px; border-radius: 10px; background: #0b1220; border: 1px solid rgba(255,255,255,0.05); }
    .pill { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 999px; font-size: 12px; }
    .pill.accent { background: rgba(16,185,129,0.12); color: #a7f3d0; }
    .pill.info { background: rgba(99,102,241,0.12); color: #c7d2fe; }
    .pill.danger { background: rgba(239,68,68,0.12); color: #fecdd3; }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    .screen-row { display: grid; grid-template-columns: 1fr 140px; gap: 10px; margin-bottom: 10px; align-items: end; }
    .row-inline { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } .screen-row { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <p class="title">üöÄ <span>Production-ready</span> Test Case Generator</p>
        <p class="muted">Submit project details, watch progress, and export a clean test plan.</p>
      </div>
      <div class="actions">
        <button class="btn secondary" type="button" id="healthBtn">Check API health</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>Project details</h3>
        <form id="generateForm">
          <label for="projectName">Project name *</label>
          <input id="projectName" name="projectName" required placeholder="e.g. Billing portal redesign" />

          <label for="description">Context</label>
          <textarea id="description" name="description" placeholder="What are we testing?" ></textarea>

          <div class="row-inline">
            <div>
              <label for="owner">Product owner</label>
              <input id="owner" name="owner" placeholder="Owner or squad" />
            </div>
            <div>
              <label for="release">Release target</label>
              <select id="release" name="release">
                <option value="Q1">Q1</option>
                <option value="Q2">Q2</option>
                <option value="Q3">Q3</option>
                <option value="Q4">Q4</option>
              </select>
            </div>
          </div>

          <div style="margin-top: 14px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <h4 style="margin:0;">Screens</h4>
              <button type="button" class="btn secondary" id="addScreenBtn">+ Add screen</button>
            </div>
            <div id="screensContainer"></div>
          </div>

          <div style="margin-top: 16px; display:flex; gap: 10px; align-items:center;">
            <button class="btn" type="submit" id="submitBtn">Generate test plan</button>
            <span class="muted" id="formHint">No external APIs required.</span>
          </div>
        </form>
      </div>

      <div class="card">
        <h3>Status</h3>
        <div class="status">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <span id="statusText">Waiting to start</span>
            <span id="statusPercent" class="muted">0%</span>
          </div>
          <div class="progress"><div class="progress-inner" id="progressBar"></div></div>
          <div class="messages" id="messages"></div>
        </div>

        <div class="card" style="margin-top:16px;">
          <h3>Downloads</h3>
          <p class="muted" id="downloadHint">Generate a plan to unlock downloads.</p>
          <div class="actions">
            <button class="btn secondary" type="button" id="downloadExcel" disabled>‚¨áÔ∏è Excel report</button>
            <button class="btn secondary" type="button" id="downloadJson" disabled>‚¨áÔ∏è JSON</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top: 20px;" id="resultsCard" hidden>
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
        <div>
          <h3 style="margin:0;">Results</h3>
          <p class="muted" id="resultMeta"></p>
        </div>
        <div class="pill accent" id="sessionBadge">Session</div>
      </div>
      <div class="summary-grid" id="summaryGrid"></div>
      <div id="screensOutput"></div>
    </div>
  </div>

  <script>
    const screensContainer = document.getElementById('screensContainer');
    const addScreenBtn = document.getElementById('addScreenBtn');
    const form = document.getElementById('generateForm');
    const submitBtn = document.getElementById('submitBtn');
    const statusText = document.getElementById('statusText');
    const statusPercent = document.getElementById('statusPercent');
    const progressBar = document.getElementById('progressBar');
    const messagesEl = document.getElementById('messages');
    const downloadExcel = document.getElementById('downloadExcel');
    const downloadJson = document.getElementById('downloadJson');
    const downloadHint = document.getElementById('downloadHint');
    const resultsCard = document.getElementById('resultsCard');
    const summaryGrid = document.getElementById('summaryGrid');
    const screensOutput = document.getElementById('screensOutput');
    const sessionBadge = document.getElementById('sessionBadge');
    const resultMeta = document.getElementById('resultMeta');
    const healthBtn = document.getElementById('healthBtn');

    let sessionId = null;
    let poller = null;

    function addScreenRow(data = {}) {
      const wrapper = document.createElement('div');
      wrapper.className = 'screen-row';
      wrapper.innerHTML = `
        <div>
          <label>Screen name</label>
          <input name="screenName" placeholder="e.g. Checkout" value="${data.name || ''}" required />
        </div>
        <div>
          <label>Platform</label>
          <select name="screenPlatform">
            <option value="WEB">Web</option>
            <option value="IOS">iOS</option>
            <option value="ANDROID">Android</option>
            <option value="TABLET">Tablet</option>
          </select>
        </div>
        <div style="grid-column: 1 / -1;">
          <label>Goals (comma separated)</label>
          <input name="screenGoals" placeholder="Sign up, apply discount" value="${(data.goals || []).join(', ')}" />
        </div>
      `;
      screensContainer.appendChild(wrapper);
    }

    function serializeScreens() {
      const rows = [...screensContainer.querySelectorAll('.screen-row')];
      return rows.map(row => {
        const name = row.querySelector('input[name="screenName"]').value.trim();
        const platform = row.querySelector('select[name="screenPlatform"]').value;
        const goalsRaw = row.querySelector('input[name="screenGoals"]').value;
        const goals = goalsRaw.split(',').map(g => g.trim()).filter(Boolean);
        return { name, platform, goals };
      }).filter(s => s.name);
    }

    function pushMessage(message, level = 'info') {
      const div = document.createElement('div');
      div.className = `msg ${level}`;
      div.textContent = message;
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function resetStatus() {
      statusText.textContent = 'Waiting to start';
      statusPercent.textContent = '0%';
      progressBar.style.width = '0%';
      messagesEl.innerHTML = '';
      pushMessage('Ready to generate a fresh plan.');
    }

    async function checkHealth() {
      healthBtn.disabled = true;
      try {
        const res = await fetch('/api/health');
        const data = await res.json();
        pushMessage(`Health: ${data.status}`, 'success');
      } catch (err) {
        pushMessage('Health check failed', 'error');
      } finally {
        healthBtn.disabled = false;
      }
    }

    async function startGeneration(event) {
      event.preventDefault();
      const payload = {
        projectName: document.getElementById('projectName').value,
        description: document.getElementById('description').value,
        owner: document.getElementById('owner').value,
        release: document.getElementById('release').value,
        screens: serializeScreens()
      };

      submitBtn.disabled = true;
      submitBtn.textContent = 'Working...';
      resultsCard.hidden = true;
      downloadExcel.disabled = true;
      downloadJson.disabled = true;
      downloadHint.textContent = 'Generating report...';
      resetStatus();

      try {
        const res = await fetch('/api/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Unable to start job');

        sessionId = data.session_id;
        sessionBadge.textContent = `Session ${sessionId.slice(0, 8)}`;
        pollStatus();
      } catch (err) {
        pushMessage(err.message, 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Generate test plan';
      }
    }

    async function pollStatus() {
      if (poller) clearInterval(poller);
      poller = setInterval(async () => {
        if (!sessionId) return;
        const res = await fetch(`/api/status/${sessionId}`);
        const data = await res.json();
        if (!res.ok) {
          pushMessage(data.error || 'Status error', 'error');
          clearInterval(poller);
          submitBtn.disabled = false;
          submitBtn.textContent = 'Generate test plan';
          return;
        }

        statusText.textContent = data.status === 'complete' ? 'Complete' : data.status;
        statusPercent.textContent = `${data.progress}%`;
        progressBar.style.width = `${data.progress}%`;
        messagesEl.innerHTML = '';
        data.messages.forEach(msg => pushMessage(`${msg.time} ¬∑ ${msg.message}`, msg.level === 'error' ? 'error' : msg.level === 'success' ? 'success' : '')); 

        if (data.status === 'complete') {
          clearInterval(poller);
          fetchResults();
        }
        if (data.status === 'error') {
          clearInterval(poller);
          submitBtn.disabled = false;
          submitBtn.textContent = 'Generate test plan';
        }
      }, 800);
    }

    async function fetchResults() {
      if (!sessionId) return;
      const res = await fetch(`/api/results/${sessionId}`);
      const data = await res.json();
      if (!res.ok) {
        pushMessage(data.error || 'Could not fetch results', 'error');
        return;
      }
      renderResults(data);
      downloadExcel.disabled = false;
      downloadJson.disabled = false;
      downloadHint.textContent = 'Downloads ready';
      submitBtn.disabled = false;
      submitBtn.textContent = 'Generate test plan';
    }

    function renderResults(result) {
      resultsCard.hidden = false;
      resultMeta.textContent = `Generated ${new Date(result.created_at).toLocaleString()}`;
      summaryGrid.innerHTML = '';
      const summaryEntries = Object.entries(result.summary);
      summaryEntries.forEach(([label, value]) => {
        const card = document.createElement('div');
        card.className = 'summary-card';
        card.innerHTML = `<div class="label">${label}</div><div class="value">${value}</div>`;
        summaryGrid.appendChild(card);
      });

      screensOutput.innerHTML = '';
      result.screens.forEach(screen => {
        const card = document.createElement('div');
        card.className = 'screen-card';
        const pill = `<span class="pill info">${screen.platform}</span>`;
        const goals = screen.goals && screen.goals.length ? screen.goals.map(g => `<span class="pill accent">${g}</span>`).join(' ') : '';
        card.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
            <div>
              <h4 style="margin:0;">${screen.name}</h4>
              <div class="muted">Goal coverage</div>
            </div>
            <div style="display:flex; gap:6px; flex-wrap:wrap;">${pill}${goals}</div>
          </div>
        `;
        const list = document.createElement('ul');
        list.className = 'case-list';
        screen.test_cases.forEach(tc => {
          const li = document.createElement('li');
          li.className = 'case-item';
          li.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;">
              <strong>${tc.case_id} ¬∑ ${tc.title}</strong>
              <span class="pill ${tc.priority === 'Critical' ? 'danger' : 'info'}">${tc.priority}</span>
            </div>
            <div class="muted" style="margin:6px 0;">${tc.category}</div>
            <div style="font-size:13px; color: var(--text);">Steps: ${tc.steps.join(' ‚Üí ')}</div>
            <div class="muted" style="margin-top:4px;">Expected: ${tc.expected}</div>
          `;
          list.appendChild(li);
        });
        card.appendChild(list);
        screensOutput.appendChild(card);
      });
    }

    downloadExcel.addEventListener('click', () => {
      if (!sessionId) return;
      window.location = `/api/report/${sessionId}/excel`;
    });
    downloadJson.addEventListener('click', () => {
      if (!sessionId) return;
      window.location = `/api/report/${sessionId}/json`;
    });

    addScreenBtn.addEventListener('click', () => addScreenRow());
    form.addEventListener('submit', startGeneration);
    healthBtn.addEventListener('click', checkHealth);

    addScreenRow({ name: 'Dashboard', platform: 'WEB', goals: ['View KPIs', 'Navigate sections'] });
    resetStatus();
  </script>
</body>
</html>
